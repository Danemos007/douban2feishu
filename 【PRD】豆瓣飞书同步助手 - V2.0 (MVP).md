# 【PRD】豆瓣飞书同步助手 - V2.0 (MVP)

## 1. 修订历史

| 版本号 | 修订日期   | 修订人  | 修订内容                                                               |
| ------ | ---------- | ------- | ---------------------------------------------------------------------- |
| V1.0   | 2025-08-07 | (AI)    | 初稿创建                                                               |
| V2.0   | 2025-08-20 | Danemos | 补充细节、FAQ模块和免责声明模块；将“同步控制与历史记录“拆分成两个tab |

## 2. 项目背景与目标

### 2.1 核心问题
对于许多同时使用豆瓣和飞书的用户来说，豆瓣原生的数据管理和展示功能过于僵化和孤立，无法满足他们进行个性化数据分析、跨平台知识联动和高级筛选决策的深度需求。本产品旨在解决这一痛点。

### 2.2 需求目标
本次MVP版本的核心目标是，为用户提供一个最基础但稳定可靠的“豆瓣数据同步到飞书”的核心功能闭环，以快速验证产品价值。
- **功能目标：** 实现用户豆瓣书影音数据到飞书多维表格的稳定、可靠的同步。
- **体验目标：** 提供清晰的配置引导，确保新用户能独立完成配置并成功运行一次同步。
- **技术目标：** 验证核心的数据抓取、对比和写入逻辑，并建立健壮的反爬虫机制。

## 3. 用户画像与场景

### 3.1 目标用户
同时使用豆瓣和飞书，并对个人书影音数据有深度归档、管理和复盘需求的知识工作者、效率爱好者或数据爱好者。

### 3.2 用户场景
- **场景一：** 年底时，用户小A想对自己过去一年的观影和读书情况做一份个性化的图文总结，但豆瓣的功能无法满足。她希望能将所有数据导入飞书，利用多维表格的强大视图能力自由分析和展示。
- **场景二：** 用户小B习惯用飞书做年度规划和读书笔记。他希望能将豆瓣的“想读”列表与飞书的年度计划关联，并在读完书后，能方便地在飞书文档中引用书籍信息，构建自己的知识库。

## 4. 功能需求详述

### 4.1 整体架构与设计
- **产品形态:** 一个采用现代前端框架（如Next.js）构建的Web应用，能同时实现优秀的SEO效果和流畅的单页应用（SPA）交互体验。
- **页面版块如下，以下版块垂直排列：**
    - **顶部导航：** 左上角包含一个简易icon
    - **首屏区域:** 包含H1主标题、一段描述性文本和一个“立即同步”的快捷按钮
    - **主体配置区域:** 采用左侧Tab导航的布局形式，包含四个核心Tab模块： `豆瓣配置` 、 `飞书配置` 、 `同步控制` 、 `同步记录` 。这一模块的详情见下方4.2-4.7
    - **FAQ区域：** 显示用户常见问题，模块详情见下方4.10
    - **免责声明区域：** 模块详情见下方4.11

### 4.2  首次配置向导
- **功能目标：** 为首次使用的用户提供一个清晰、线性的引导流程，帮助其无障碍地完成所有必要配置。
- **业务规则与逻辑:**
    - 系统通过检查浏览器本地存储（ `localStorage` ）中是否存在“用户设备ID”来判断是否为新用户。若为新用户，则启动向导模式。
    - 在该模式下，当点击首屏的“立即同步”按钮时，用户会跳转到下方配置模块，同时页面弹出hover “请先完成相关配置再同步！”
    - 配置区域下方会显示“上一步”和“保存并进入下一步”按钮，引导用户依次完成各配置Tab。
- **验收标准:**
    - 新用户访问时，能自动进入向导模式。
    - 能通过点击“下一步”和“上一步”在不同配置Tab间流转。

### 4.3 普通设置中心模式
- **功能目标:** 在用户完成首次配置后，提供一个灵活、自由的设置管理界面。
- **业务规则与逻辑:**
    - 当用户完成首次配置向导后，产品进入此常驻模式。
    - 首屏的“立即同步”快捷按钮点击后，将立刻进行同步动作。
    - 主体配置区域的“上一步”、“下一步”等向导按钮将永久消失。
    - 用户可以通过主体配置区域左侧的Tab导航，自由地切换到任何一个配置模块进行查看或修改。
    - 每个配置模块（如“豆瓣配置”）的“保存”按钮，仅在用户对该模块内的配置项做出修改后才出现或激活。
- **验收标准:**
    - 完成向导后，页面正确进入该模式。
    - 用户可以自由切换Tab。
    - “保存”按钮的出现/激活逻辑符合预期。

### 4.4 顶部导航
- 顶部导航左侧有个“D2F”的icon。

### 4.5 首屏区域
- **文案内容：**
    - H1标题 ：将豆瓣数据同步到飞书多维表格
    - 描述性文本 ：打造你的个性化知识管理系统，让书影记录与计划、笔记深度联动
    - 同步按钮 ：立即同步
    - 免责声明：*本工具为非官方项目，与豆瓣和飞书无任何隶属关系，仅供个人学习使用
    - 补充说明：请先完成下方配置后再进行数据同步
- **样式 ：**
    - 所有内容均为居中对齐。
    - 免责声明和补充说明的文案颜色均采用浅灰色
    - 补充说明文案的右侧需要有个向下的箭头

### 4.6 主体配置区域tab1：豆瓣配置
- **功能目标** ：引导用户安全、便捷地提供其豆瓣Cookie，作为后续数据抓取的身份凭证。
- **业务规则与逻辑** :
    - 左侧tab中的“豆瓣配置”为H2
    - 界面显示H3“豆瓣账号配置”，居左对齐；下方显示一条浅灰色分隔线
    - 再往下是一行字H3“豆瓣 Cookie”；该行字下方提供一个大的文本输入框，用于用户粘贴从浏览器中获取的完整Cookie字符串，输入框中用浅灰色字体显示“请粘贴从浏览器开发者工具中获取的完整 Cookie 字符串”
    - 输入框下方是一行字“如何获取Cookie”和一个向右的箭头“>”，字号比“豆瓣Cookie”小两个字号。点击这行字可展开cookie获取教程，同时向右箭头变成向下；再次点击这行字可收起教程，同时箭头恢复回向右。教程区整体布局如下：
        - 总共有4个步骤，均为图文教程，从上往下排列。所有图片点击后均可放大预览，方便用户查看细节。
        - **第1步**
            - 文案标题：登录豆瓣账号并打开开发者工具
            - 文案内容：在豆瓣网站登录账号后，鼠标右键点击“检查”来打开开发者工具，接着点击顶部导航栏的  “Network”  选项。
            - 图片链接稍后提供，先设置占位空图片即可
        - **第2步**
            - 文案标题：刷新页面，找到主请求并查看其标头(Headers)
            - 文案内容：按F5(Win)或者按cmd+R(Mac)来重新加载一次豆瓣页面。在“Network”面板左侧的请求列表中，点击第一个请求（通常就是  www.douban.com  这个主文档），右侧会出现该请求的详细信息，点击  “Headers”  子面板。
            - 图片链接稍后提供，先设置占位空图片即可
        - **第3步**
            - 文案标题：找到并复制完整的Cookie值
            - 文案内容：在“Headers”面板里向下滚动，找到  “Request Headers”  部分，在该部分里找一个名为  `cookie:`  的行，接着将该行右侧的所有值选中并右键选择“复制”
            - 图片链接稍微提供，先设置占位空图片即可
    - 在向导模式下，底部有一个可点击的按钮“验证并保存Cookie”和一个置灰的“下一步”按钮。点击“验证并保存Cookie”后，系统向后端发送验证请求并显示加载状态。验证成功后，显示成功提示信息，并将“下一步”按钮激活，成为可点击状态；验证失败则显示失败提示，“下一步”按钮保持置灰。
    - 在普通设置模式下，底部默认无任何按钮，只有当修改了配置内容后才会出现一个可点击的按钮“验证并保存Cookie”。点击该按钮后，系统向后端发送验证请求并显示加载状态。验证成功后，显示成功提示信息“您的cookie信息已保存成功”；验证失败则显示失败提示，cookie信息保留旧cookie
- **验收标准** :
    - 用户能根据教程成功获取并填入Cookie。
    - 系统能对Cookie的有效性进行实时校验并向用户反馈正确的结果。
    - 向导流程的按钮状态转换符合预期。

### 4.7 主体配置区域tab2：飞书配置

#### 4.7.1 功能点1：飞书凭证配置
- **功能目标** ：引导用户配置其飞书企业自建应用的 `App ID` 和 `App Secret` 。
- **业务规则与逻辑** :
    - 左侧tab中的“飞书配置”为H2
    - 界面上方显示H3“飞书凭证配置”，居左对齐；下方显示一条浅灰色分隔线
    - 接着提供两个标准的输入框，分别用于填写 `App ID` 和 `App Secret` 。
    - 下方提供一个可展开/收起的详尽图文教程，指导用户完成创建应用、开启权限、添加应用到表格、回到飞书开放平台复制App ID和App secret等所有必要步骤。教程区的逻辑和样式同上述4.6中的图文教程，只不过本操作步骤包括了4步。具体文案和图片稍后配置，请先留好占位。
- **验收标准** :
    - 用户能根据教程成功获取并填入飞书凭证。

#### 4.7.2 功能点2：数据映射配置
- **功能目标** ：允许用户选择数据存放策略，并配置好对应的飞书多维表格。
- **业务规则与逻辑** :
    - 显示H3“数据映射配置”，居左对齐；下方显示一条浅灰色分隔线
    - 提供一组单选按钮，让用户选择数据映射方案
        - 方案一：3个表（图书、电影、电视剧和纪录片）
        - 方案二：4个表（图书、电影、电视剧、纪录片）
    - 方案选择下方有一行小字“如何获取多维表格ID和table ID”和一个向右的箭头“>”。点击该行字展开一个图文教程，且向右箭头“>”同时变成向下，教程区为一行字和一张图片；点击“如何获取多维表格ID和table ID”教程收起，同时箭头恢复变成向右。文案和内容稍后提供，请先留空。
    - 根据用户的选择，下方动态展示对应数量的配置卡片。若选择方案一，下方则呈现3张卡片的配置项，3张卡片的标题分别为“图书”、“电影”、“电视剧和纪录片”；若选择方案二，下方呈现4张卡片的配置项，4张卡片的标题分别为“图书”、“电影”、“电视剧”、“纪录片”
    - 每张卡片中提供两个输入框用于填写“飞书多维表格ID”和“Table ID”；并用一条浅灰色分隔线隔开，下方显示“将同步的字段”，不同卡片的字段详情如下：
        - **图书（16个字段）** ：Subject ID、我的标签、我的状态、书名、副标题、豆瓣评分、作者、我的备注、内容简介、封面图、我的评分、原作名、译者、出版年份、出版社、标记日期
        - **电影（18个字段）** ：Subject ID、我的标签、我的状态、类型、电影名、封面图、豆瓣评分、我的备注、片长、上映日期、剧情简介、主演、导演、编剧、制片地区、语言、我的评分、标记日期
        - **电视剧和纪录片/电视剧/纪录片（19个字段）** ：Subject ID、我的标签、我的状态、类型、片名、封面图、豆瓣评分、单集片长、集数、首播日期、剧情简介、我的备注、主演、 导演、编剧、制片地区、语言、我的评分、标记日期
    - 在向导模式下，进入这个tab时，底部显示“上一步”按钮(副按钮)和置灰的“保存并进入下一步”按钮(主按钮)。当配置内容填写完毕后，“保存并进入下一步”按钮激活，成为可点击状态。
    - 在普通设置模式下，底部默认无任何按钮，只有当修改了配置内容后才会出现一个可点击的按钮“保存配置”，点击后保存最新配置信息，并弹出保存成功提示。下次同步数据时按照最新配置信息进行。
- **验收标准** :
    - 能根据用户选择，动态展示正确的配置卡片数量。
    - 用户填写的ID能被正确保存。

### 4.8 主体配置区域tab3：同步控制
- **功能目标** ：允许用户设置一个简单的自动同步规则。
- **业务规则与逻辑** :
    - 左侧tab中的“同步控制”为H2
    - 界面上方显示H3“同步控制”，居左对齐；下方显示一条浅灰色分隔线
    - 再往下为一行文字“自动同步设置”，接着提供一个下拉菜单，选项包括：“关闭自动同步”、“每天”、“每周一”、“每周二”、“每周三”、“每周四”、“每周五”、“每周六”、“每周日”；当选择“每天”或“每周X”时，旁边提供一个独立的时间选择器，允许用户设置具体时间（如22:30）
    - 在向导模式下，自动同步配置项下方显示“上一步”按钮(副按钮)和“完成配置”按钮(主按钮)。当点击“完成配置”后，下方会出现一行字“现在，您可点击首屏的‘立即同步’按钮进行数据同步，否则系统将根据您的自动同步时间配置信息，在指定时间进行同步”
    - 在普通设置模式下，当修改了自动同步配置的内容，会出现一个可点击的按钮“保存配置”，点击后保存最新配置信息，并弹出保存成功提示
- **验收标准** :
    - 用户能成功设置一条自动同步规则。
    - 后端定时任务能根据用户设置，在正确的时间被触发。

### 4.9 主体配置区域tab4：同步记录
- **功能目标** ：实时、透明地展示所有同步任务的状态与历史。
- **业务规则与逻辑** :
    - 左侧tab中的“同步记录”为H2
    - 界面上方显示H3“历史同步记录”，居左对齐；下方显示一条浅灰色分隔线
    - 接着显示“累计同步总次数：xx 次”
    - 下方为一个同步历史列表，列表中每一条记录需包含：触发时间、触发类型、任务状态、花费时间、同步详情、同步状态(成功/失败/进行中)
    - 点击“立刻同步”后，列表需在不刷新页面的情况下，立刻在顶部插入一条状态为“进行中”的新纪录。
    - 当后端任务状态变更后，前端列表对应记录的状态也需自动实时更新。
- **验收标准** :
    - 历史列表能正确展示所有必需信息。
    - 列表状态能实现无刷新的实时更新。

### 4.10 FAQ版块
- **功能目标** ：提供用户常见FAQ，解决用户使用过程中的疑问
- **模块布局** :
    - **标题：** 标题内容为“FAQ”，H2大小，居左对齐
    - **正文：**
        - **展开收起逻辑：**
            - 当点击每个问题的那一行时，可展开/收起该问题的答案
            - 默认展开第一个FAQ的答案
            - 一次最多只呈现一个问题的答案。因此，如果此时有另一个旧问题的答案展开着，当用户点击一个新问题，页面在展开该新问题的内容时，需要同时将旧问题的答案收起
        - **样式：**
            - 问题和答案均为左对齐
            - 问题字号要比正文字号大2px~4px。问题字体要加粗，答案字体不加粗。答案字体颜色比问题稍微浅一些
            - 每个问题的右侧有个小箭头，该小箭头居右对齐。当收起答案时，右侧小箭头向右，形状类似于“>”；当展开答案时，右侧小箭头方向转为向下
    - **内容：**
        - **问题内容** ：如果我已有手动整理的、但列名称(字段名称)不同的旧表格，我可以用D2F将豆瓣数据同步到我的旧表格吗？
        - **答案内容** ：这种情况强烈建议用一个新表格。因为当旧表格的列名称与D2F工具的默认表头名称不同时，工具匹配不到，便会认为该列不存在，于是会创建全新的列并将数据填进去，最终您的表格会很混乱。
        - **问题内容** ：如果我已有手动整理的旧表格，并将旧表格的表头名称修改到跟D2F的默认表头名称完全一致，这种情况下我可以将数据同步到我的旧表格吗？
        - **答案内容**： 这种情况下，D2F能够识别到列并直接利用您的现有结构，不会创建新的列。但还需要考虑内容同步问题。①如果想让dou2feishu将增量内容同步到您的旧表格中，那么需要确保旧表格中的每项书籍和影视条目都有正确的subject ID，且subject ID位于第一列。②如果您希望不要破坏表格中的旧内容，那么表格中的旧内容必须跟您豆瓣账户中的最新数据一致。当不一致时，D2F会以豆瓣账户的最新数据为准，修改您旧表格中的内容。
        - **问题内容** ：D2F所同步的列太多了，有些数据我不需要，该怎么办？
        - **答案内容**： 在D2F完成第一次数据同步后，您可以自行隐藏您所不想看到的列。 隐藏不会影响过后的数据同步。
        - **问题内容**： D2F所同步的列的顺序我不喜欢，我想调整列顺序，可以吗？
        - **答案内容** ：您可以在D2F完成第一次数据同步后，调整除了第一列外的其他任何列的顺序，这不会影响过后的数据同步。第一列是索引列，所以顺序不可调整。
        - **问题内容** ：D2F所同步的列名称我不喜欢，想换成其他的，可以吗？
        - **答案内容**： 可以的。您可以在D2F完成第一次数据同步后，将表头名称换成您所喜欢的名字（比如，可以将“书名”改为“书籍名称”之类），这不会影响过后的数据同步。但有个事情需要注意。在D2F第一次同步完数据后，每一列的性质（所传达的含义）就被永久确定了。比如原先传达书名含义的列会永久表达书名，所以改名时建议围绕该列的原性质来改名，而不应该将其改为“豆瓣评分”“导演”等表达其他含义的名称。
- **验收标准** :
    - 可正常展开/收起答案

### 4.11 免责声明
- **内容：**
    - **标题内容** ：免责声明
    - **正文内容** ：
        - 本工具与豆瓣或飞书官方无任何关联。
        - 使用本工具前，建议备份您的数据，以防万一。因使用本工具所造成的损失，由使用者本人承担。
        - 本工具没有爬取任何书影等内容，只供学习交流和技术研究使用。没有侵犯书影作者版权和豆瓣官方利益。如有任何侵权行为，请联系我删除。
        - 使用本工具，即视为同意上述免责声明。
- **样式** ：
    - 标题和正文均为居左对齐。标题比正文大2px，标题加粗，正文不加粗。

## 5. 边界条件与约束
- **用户识别：** MVP版本通过浏览器本地存储识别用户设备，清理缓存或更换设备/浏览器，会导致用户需要重新配置。
- **Cookie时效性：** 豆瓣Cookie具有一定的时效性，过期后用户需按教程重新获取并配置。
- **API频率限制：** 后端程序在执行同步时，需内置合理的请求延迟和队列机制，以避免触发豆瓣和飞书的API频率限制。

## 6. 非功能性需求
- **安全性需求** : 用户配置的Cookie和飞书凭证在传输过程中需加密，在后端存储时也应采取加密措施。
- **易用性需求** : 核心配置流程需有清晰的引导，非技术用户能独立完成。
- **兼容性需求** : 支持主流浏览器（Chrome, Firefox, Safari, Edge）的最新版本。

## 7. 数据指标
为衡量产品使用情况和健康度，需在应用中集成基础的数据分析工具（如Vercel Analytics或Google Analytics），并追踪以下核心指标：
- **活跃用户数 (MAU/DAU):** 衡量产品的用户基数和粘性。
- **同步任务总数:** 衡量产品的核心功能使用频率。
- **手动同步与自动同步占比:** 分析用户的使用偏好。
- **同步成功率:** 监控产品的稳定性和健康度。

## 8. 技术实现概要
- **数据抓取：** 不爬取网页HTML。应调用豆瓣隐藏的移动端API（如  `https://m.douban.com/api/v2/user/[USER_ID]/interests` ）来获取结构化的JSON数据。
- **反爬虫策略：** 所有对豆瓣的请求，必须携带完整的、从用户处获取的Cookie，并伪装成真实的浏览器 `User-Agent` 。在循环抓取多页数据时，必须加入随机的、秒级的请求延迟。
- **数据写入：** ~~对飞书多维表格的写入应采用"认ID不认名"的策略，通过保存 `Field ID` 来确保数据写入的准确性~~ **采用字段名匹配策略，通过字段名进行精确匹配和数据写入**，并允许用户自由修改列名。**策略更正：** 经API测试验证，飞书多维表格API仅支持字段名操作，无法通过Field ID直接写入数据。
- **数据清洗逻辑：** 在处理 `type=tv` 的数据时，需增加一步清洗逻辑。当用户的映射方案选择将“纪录片”与“电视剧”分表存放时，程序需检查返回条目的 `genre` （类型）字段。若 `genre` 字段中包含“纪录片”字符串，则该条目应被归类到“纪录片”表格中，否则归类到“电视剧”表格中。
- **数据同步的增删改(CRUD)逻辑:**
    - **唯一键：** 使用“Subject ID”作为所有记录的唯一标识符。
    - **新增(Create)：** 若一个Subject ID在飞书中不存在，则在对应表格中新增一行记录。
    - **更新(Update)：** 若Subject ID已存在，则对比所有字段。任一字段有变动，则更新飞书中的该行记录。一个重点场景是用户将条目从“想看”改为“看过”，此时“我的状态”、“标记日期”、“我的评分”等字段都需要被更新。
    - **删除(Delete)：** 在同步任务开始时，先记录飞书中所有相关Subject ID。同步任务结束后，若记录中的某个ID在本次抓取中未出现，则从飞书中删除该行数据。
- **实时更新：** 前端应采用轮询（Polling）或WebSocket等技术，实现同步状态的无刷新实时更新。
