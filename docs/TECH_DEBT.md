# 项目技术债务清单 (Project Technical Debt Log)

本文档用于记录项目中已知的设计或实现上的妥协，以便未来进行跟踪和偿还。

---

### TD-001: Zod 库版本固定在 v3

* **债务识别日期**: 2025-09-08
* **状态**: 🔴 已接受 (Accepted)

#### **背景与原因 (Context & Reason)**

在尝试修复 Zod v4 引起的 `TS1259` 编译错误时，我们发现根治方案（`"moduleResolution": "node16"`）与项目当前基于 CommonJS 的 NestJS 架构存在根本性冲突，升级风险极高。为保证项目稳定性和开发进度，我们决策放弃升级，将 Zod 库版本降级并固定在最新的 v3 版本（`3.23.8`）。

#### **债务成本 (Debt Cost / Impact)**

1.  **功能滞后**: 无法使用 Zod v4 及更高版本的新特性、Schema 优化和性能改进。
2.  **安全风险**: 长期来看，Zod v3 的安全更新和社区支持将逐渐停止。
3.  **生态脱节**: 社区新的教程、文章和相关库将主要围绕 Zod v4+ 构建，增加团队成员的学习和整合成本。

#### **偿还计划 (Repayment Plan)**

此技术债务的偿还与整个项目的模块系统升级强相关。我们将在以下时机重新评估并着手偿还此债务：

* **触发条件**: 当我们计划将项目整体从 CommonJS 迁移到 ESM 架构时，或当 NestJS 官方对 ESM 提供更成熟、稳定的支持时。
* **偿还步骤**:
    1.  执行项目级的 ESM 迁移。
    2.  将 Zod 升级到最新版本。
    3.  移除此条技术债务记录。

---

### TD-002: 项目模块系统从 CommonJS (CJS) 迁移至 ECMAScript Modules (ESM)

* **债务识别日期**: 2025-09-08
* **状态**: 🔵 已规划 (Planned) / 待办 (Backlog)

#### **背景与原因 (Context & Reason)**
在解决 Zod v4 的编译问题时，我们发现项目的 CJS 架构与现代 TypeScript 的 ESM 解析策略存在冲突。为了在项目初期规避巨大的架构迁移风险、优先保障产品功能开发和上线，我们决定推迟整个项目的 ESM 迁移工作。

#### **债务成本 (Debt Cost / Impact)**
1.  无法使用仅支持 ESM 的新型 npm 包。
2.  与 Node.js 和 TypeScript 的未来主流方向暂时脱节。
3.  某些现代构建工具和库的性能优势无法完全发挥。

#### **偿还计划 (Repayment Plan)**
这是一个“史诗级”重构任务，应在一个独立、完整、不受干扰的开发周期内完成。
* **触发条件**:
    1.  产品核心功能已上线，并稳定运行至少1-3个月后。
    2.  在规划项目的下一个主要版本（例如 v2.0）时，可将其作为核心技术升级任务。
    3.  当遇到必须使用某个仅支持 ESM 的“杀手级”库时。
* **偿还步骤**: 需单独制定详细的迁移、测试和灰度发布计划。

---

### TD-003: 性能测试 `field-mapping.performance.spec.ts` 的深度优化被延期

* **债务识别日期**: 2025-09-17
* **状态**: 🔴 已接受 (Accepted)

#### **背景与原因 (Context & Reason)**

`FieldMappingService` 的性能测试 (`performance.spec.ts`) 在 CI/CD 环境中因“30000ms 超时”而频繁失败，阻塞了开发流程。经过初步分析，原因是该性能测试的复杂度和资源消耗较高，超出了 Jest 的默认超时配置。

为了优先保障产品 MVP 版本的开发进度和按时上线，我们决定采取一个临时的、低成本的解决方案来恢复CI/CD的稳定性。根据本地基准测试，该测试稳定运行时间约5-10秒。为保证在资源受限的CI环境中也能稳定通过，已将超时阈值预防性地设置为60秒。我们**有意识地决定 (Conscious Decision)** 推迟对该问题的深度根因分析（例如，是测试本身设计不佳还是服务代码存在真实性能瓶颈）和潜在的代码重构工作。

#### **债务成本 (Debt Cost / Impact)**

1.  **掩盖潜在性能问题**: 最主要的风险。当前的临时解决方案可能掩盖了 `FieldMappingService` 服务本身存在的真实性能瓶颈。这可能导致该服务在生产环境、真实负载下表现不佳，影响用户体验。
2.  **性能基准不明确**: 虽然我们已建立本地测试的性能基准（约5-10秒），但这并未反映服务在生产环境真实负载下的表现。我们对核心服务在生产环境的性能拐点依然是模糊的，这使得未来更难发现和定位性能衰退（Performance Regression）。
3.  **测试套件健康度下降**: 该测试用例的长时间运行会略微增加整体测试套件的执行时间。如果未来有更多此类测试出现，会拖慢整体的 CI 反馈循环。


#### **偿还计划 (Repayment Plan)**

此债务的偿还应在一个功能迭代相对稳定的周期内进行。

* **触发条件**:
    1.  产品 MVP 版本成功上线，并稳定运行一段时间后（例如 1-2 个 Sprint）。
    2.  在规划项目的下一个主要版本（例如 v1.1）时，应将此任务纳入技术优化列表，并重新评估其优先级。
    3.  当生产环境的监控数据显示 `FieldMappingService` 的 API 响应时间出现显著劣化，或收到用户关于相关功能缓慢的反馈时，此任务的优先级应立刻被提至最高。
* **偿还步骤**:
    1.  **深度分析**: 重新运行并剖析（Profile）该性能测试，定位耗时的主要瓶颈，确定问题根源在于“测试代码的设计”还是“服务本身的实现”。
    2.  **分类处理**:
        * 如果问题在于测试，则重构测试用例（如优化 Mock、减少不必要的循环等）。
        * 如果问题在于服务，则创建一个独立的性能优化任务，并对服务代码进行重构和改进。
    3.  **建立基准**: 在修复后，建立一个稳定、可靠的性能测试基准，并设置一个合理的超时阈值。
    4.  **关闭债务**: 验证问题已解决后，移除此条技术债务记录。