# 豆瓣数据抓取测试说明

## 测试环境

我们已经实现了基于 obsidian-douban 成熟方案的豆瓣数据抓取系统，现在可以进行测试。

## 获取测试所需信息

### 1. 获取豆瓣Cookie

1. **登录豆瓣网站**
   - 打开 https://www.douban.com
   - 使用你的豆瓣账号登录

2. **获取Cookie**
   - 按 F12 打开开发者工具
   - 切换到 Network 标签
   - 刷新页面
   - 点击任意一个请求
   - 在 Headers 中找到 Cookie 字段
   - 复制完整的Cookie字符串

3. **Cookie示例格式**
   ```
   bid=abc123; ll="108296"; __utma=30149280.135860784.1691572641.1691572641.1694509646.2; dbcl2="131038721:LUssju34QFw"; ck=dCQj; ...
   ```

### 2. 获取豆瓣用户ID

1. **访问个人主页**
   - 登录后点击右上角头像
   - 进入个人主页

2. **从URL获取ID**
   - URL格式：`https://www.douban.com/people/[用户ID]/`
   - 如：`https://www.douban.com/people/123456789/`
   - 用户ID就是：`123456789`

## 运行测试

### 命令格式
```bash
npm run test:douban "你的Cookie" "你的用户ID"
```

### 示例
```bash
npm run test:douban "bid=abc123;ll=\"108296\";dbcl2=\"131038721:LUssju34QFw\";ck=dCQj" "123456789"
```

## 测试流程

测试脚本会执行以下步骤：

1. **验证参数**
   - 检查Cookie和用户ID是否提供

2. **获取书籍列表页**
   - 访问：`https://book.douban.com/people/[用户ID]/collect`
   - 解析列表中的书籍信息
   - 显示找到的书籍数量和总数

3. **获取书籍详情**
   - 选择第一本书获取详细信息
   - 解析JSON-LD结构化数据
   - 解析用户评分、标签等个人数据

4. **显示统计信息**
   - 请求次数
   - 当前延迟模式（正常/慢速）

## 预期输出

正常情况下会看到类似输出：

```
=== 豆瓣数据抓取独立测试 ===

测试用户: 123456789
Cookie长度: 256 字符

1. 测试获取书籍列表页...
[正常模式] 延迟 6 秒
[请求] https://book.douban.com/people/123456789/collect?start=0&sort=time&rating=all&filter=all&mode=list
[成功] 获取到 45632 字符
找到 30 本书籍，总数: 156

前3本书籍:
  1. 三体 (ID: 2567698)
  2. 百年孤独 (ID: 1041040)  
  3. 1984 (ID: 5299764)

2. 测试获取书籍详情...
[正常模式] 延迟 7 秒
[请求] https://book.douban.com/subject/2567698/
[成功] 获取到 78234 字符

书籍详情:
  标题: 三体
  评分: 8.8
  作者: 刘慈欣
  ISBN: 9787229030896
  我的评分: 9.0
  我的标签: 科幻, 小说

=== 测试完成 ===
总请求数: 2
当前模式: 正常
```

## 常见问题

### 1. Cookie失效
```
❌ 测试失败: 遇到人机验证，请检查Cookie

可能的解决方案:
1. 重新获取Cookie
2. 等待一段时间后再试
3. 检查网络连接
```

### 2. 用户ID错误
- 检查URL是否正确复制
- 确认用户主页是公开的

### 3. 没有找到书籍
```
找到 0 本书籍，总数: 0
❌ 未找到书籍数据，请检查用户ID和Cookie
```

## 安全提醒

- ⚠️ Cookie包含敏感信息，请不要在公共场合分享
- ⚠️ 测试后建议重新登录豆瓣以刷新Cookie
- ⚠️ 请遵循豆瓣的使用条款，不要过度抓取

## 技术细节

### 反爬虫策略
- **延迟控制**: 4-8秒随机延迟，200次后切换到10-15秒
- **Headers伪装**: 标准浏览器Headers
- **人机验证检测**: 监测`<title>禁止访问</title>`

### 数据解析
- **优先级**: JSON-LD > Meta标签 > DOM选择器
- **容错处理**: 多种选择器备选方案
- **类型安全**: TypeScript类型检查

---

现在可以开始测试了！请准备好你的豆瓣Cookie和用户ID。